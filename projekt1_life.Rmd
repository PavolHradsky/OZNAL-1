---
title: "OZNAL projekt 1"
author: "Peter Slovak, Pavol Hradsky"
date: "2024-03-26"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(magrittr)
library(ggplot2)
getwd() 
#setwd("C:/Users/hrads/Documents/Programming/Ing/2Semester/OZNAL/projekt1") #set working directory
```

## Bc. Peter Slovák, Bc. Pavol Hradský

# Načítanie dát, neupravené 

```{r load}
data <- read_csv("Life Expectancy Data.csv", col_names = TRUE)
data
```

# Čo je v našich dátach?

```{r}
str(data)
head(data)
dim(data)
sapply(data, class)
sapply(data, function(x) sum(is.na(x)))
```

Dáta obsahujú 22 stĺpcov a 2938 záznamov o kvalite a dĺžke života v 193 krajinach naprieč rokmi 2000-2015. 


```{r}
column_types_count <- table(sapply(data, class))
column_types_count
```

20 stĺpcov je numerických a 2 kategorické. Niektoré stĺpce obsahujú aj NA hodnoty.

Kategorické stĺpce: Country, Status.

Numerické stĺpce: Year, Life expectancy, Adult Mortality, infant deaths, Alcohol, percentage expenditure, Hepatitis B, Measles, BMI, under-five deaths, Polio, Total expenditure, Diphtheria, HIV/AIDS, GDP, Population, thinness 1-19 years, thinness 5-9 years, Income composition of resources, Schooling.

```{r}
# We are going to check Life expectancy because it is the most important column for us, prediction will be done on this value

# check for missing values in column Life expectancy
missing_values_life_axpextancy <- sum(is.na(data$`Life expectancy`))
missing_values_life_axpextancy
# there is 10 missing values in column price

# check also for empty strings
empty_values_life_axpextancy <- sum(str_detect(data$`Life expectancy`, "^\\s*$"))
empty_values_life_axpextancy
```

Vidíme, že v stĺpci Life expectancy sa nachádza len 10 prázdnych hodnôt - NA a žiaden prázdny reťazec. Tento stĺpec bude pre nás dôležitý pri lineárnej regresii, kde budeme predikovať práve dlzku zivota na základe iných parametrov. Rozhodli sme sa dropnúť riadky s chýbajúcimi hodnotami v tomto stĺpci.

# Úprava datasetu o stĺpec Continent, pre možné budúce použitie

```{r}

install.packages("countrycode", repos="https://cloud.r-project.org/")
library(countrycode)
data$Continent <- countrycode(data$Country, "country.name", "continent")
data


```

# Čistenie datasetu

```{r}
# drop rows with missing values in column Life expectancy
data <- data %>% drop_na(`Life expectancy`)
missing_values_life_axpextancy <- sum(is.na(data$`Life expectancy`))
missing_values_life_axpextancy
dim(data)
```


# Histogramy

```{r}

data %>%
  count(Status) %>%
  rename(Count = n) %>%
  ggplot(aes(x=Status, y=Count)) + 
  geom_histogram(stat="identity", aes(fill=Count)) + 
  scale_fill_viridis_c()

data %>%
  count(Year) %>%
  rename(Count = n) %>%
  ggplot(aes(x=Year, y=Count)) + 
  geom_histogram(stat="identity", aes(fill=Count)) + 
  scale_fill_viridis_c()

data %>%
  count(`Life expectancy`) %>%
  rename(Count = n) %>%
  ggplot(aes(x=`Life expectancy`, y=Count)) + 
  geom_histogram(stat="identity", aes(fill=Count)) + 
  scale_fill_viridis_c()

data %>%
  count(`Adult Mortality`) %>%
  rename(Count = n) %>%
  ggplot(aes(x=`Adult Mortality`, y=Count)) + 
  geom_histogram(stat="identity", aes(fill=Count)) + 
  scale_fill_viridis_c()
```

Pri zobrazení histogramov vidíme, že v datasete je omnoho viac záznamov s rozvojových krajín ako z rozvinutých. Roky, v ktorých boli robené merania, sú zastúpené rovnomerne. Pred odstránením predchádzajúcich 10 riadkov pre chýbajúce záznamy v Life expectancy sme mali v jeden rok viac záznamov. Ďalej vidíme rozdelenie dĺžky života a adult mortality.

# Zvyšné chýbajúce hodnoty


```{r, echo=F}
missing_values_na <- sapply(data, function(x) sum(is.na(x)))
missing_values_na <- data.frame(column = names(missing_values_na), missing_values = missing_values_na)
missing_values_na$type <- "NA"

# Count empty strings for each column
missing_values_empty <- sapply(data, function(x) sum(str_detect(x, "^\\s*$")))
missing_values_empty <- data.frame(column = names(missing_values_empty), missing_values = missing_values_empty)
missing_values_empty$type <- "Empty String"

# Combine the two datasets
combined_missing_values <- rbind(missing_values_na, missing_values_empty)

# Plotting
ggplot(combined_missing_values, aes(x = column, y = missing_values, fill = type)) +
  geom_col(position = "dodge") +
  labs(title = "Distribution of Missing and Empty Values for Each Dataset Column",
       x = "Column", y = "Count of Missing and Empty Values") +
  scale_fill_manual(values = c("NA" = "blue", "Empty String" = "red")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Kontrolovali sme aj ostatné chýbajúce hodnoty. Vidíme, že pomerne dosť sa ich nachádza aj v stĺpcoch Population a hepatits B alebo GDB. V ostaných je len menej, alebo žiadne.

## Pairplot

```{r}
#-----Helper functions-----
panel.cor <- function(x,y, digits=2, prefix="", cex.cor){
  usr <- par("usr")
  on.exit(par(usr))
  par(usr = c(0,1,0,1))
  r <- abs(cor(x,y,use="complete.obs"))
  txt <- format(c(r,0.123456789), digits = digits)[1]
  txt <- paste0(prefix, txt,sep="")
  if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
  text(0.5, 0.5, txt, cex = cex.cor * (1 + r) / 2)
}

panel.hist <- function(x, ...){
  usr <- par("usr")
  on.exit(par(usr))
  par(usr = c(usr[1:2],0,1.5))
  h <- hist(x, plot = FALSE)
  breaks <- h$breaks
  nB <- length(breaks)
  y <- h$counts
  y <- y/max(y)
  rect(breaks[-nB], 0, breaks[-1], y, col="white",...)
}

panel.lm <- function(x, y, col = par("col"), bg = NA, pch = par("pch"),
                     cex = 1, col.smooth = "blue", ...) {
  points(x, y, pch = pch, col = col, bg = bg, cex = cex)
  abline(stats::lm(x ~ y), col = "steelblue", ...)
} 
pairs(~ `Life expectancy` + `Adult Mortality` + Alcohol  +
        `percentage expenditure` + BMI + 
        `Total expenditure` + Diphtheria + `HIV/AIDS` + GDP +
        `Income composition of resources` +
        Schooling, 
      data = data,
      upper.panel= NULL, 
      diag.panel = panel.hist,
      lower.panel = panel.lm)
```

Vybrali sme len stĺpce, ktoré najviac korelujú so stĺpcom Life expectancy, ktorý sa budeme snažiť predikovať. 

# Hypotézy
Hypotézy, ktoré sa nám zdajú zaujímavé:
1. percentage expenditure vs GDP nieco???
2. Človek, ktorý ... sa dožíva dlhšieho veku. (niečo s alkoholom a choroby)
3. Človek, ktorý žije v krajinách s vyšším GDP sa dožíva dlhšieho veku.
4. človek, ktorý dlhšie študuje a je viac vzdelaný sa dožíva dlhšieho veku.

Náš response variable bude "Life expectancy" a ostatné stĺpce budú prediktory.


# Lineárna regresia - model

```{r}
# linear regression model
model <- lm(`Life expectancy` ~ `Adult Mortality` + Alcohol  +
              `percentage expenditure` + BMI + 
              `Total expenditure` + Diphtheria + `HIV/AIDS` + GDP +
              `Income composition of resources` +
              Schooling, data = data)
summary(model)
```
TODO popisat model
Chceli by sme mat Median priblizne v strede medzi Max a Min hodnotou.
Co priblizne sedi, median ma hodnotu -0.0527, Max ma hodnotu 21.9899 a Min ma hodnotu -21.1648. Nasa disribucia je symetricka.

Z modelu vidime, ze Adult Mortality, HIV/AIDS a Alcohol maju negativny vplyv na Life expectancy. Naopak Total expenditure, BMI, Diphtheria, GDP, Income composition of resources a Schooling maju pozitivny vplyv na Life expectancy.
Multiple R-squared:  0.8188 ,a hodnotu 82.84% co znamena, ze nase prediktory vysvetluju 82.84% variacie v Life expectancy.
Hviezdičky pred hodnotami p-value znamenaju, ze su signifikantne.


```{r}

```{r}
# Quantile-quantile plot 
qqnorm(model$residuals)
qqline(model$residuals)
```

```{r}
# Residuals vs Fitted plot
plot(model$residuals, model$fitted.values)
```

```{r}

# Normality test for hypothesis?
shapiro.test(model$residuals)
```


Ďalší možný zaujímavý model

```{r}
model <- lm(`Alcohol` ~ `Adult Mortality` + BMI + `HIV/AIDS` + GDP +
              `Income composition of resources` +
              Schooling, data = data)
summary(model)
```
TODO popisat model
Median mame priblizne v strede medzi Max a Min hodnotou, co je dobre. Max hodnota je 10.9662a Min hodnota je -9.8691. Nas model je symetricky rozdeleny.
Z modelu vidime, ze Adult Mortality, BMI, HIV/AIDS, GDP, Income composition of resources a Schooling maju pozitivny vplyv na Alcohol.
Multiple R-squared:  0.3361 ,a hodnotu 33.61% co znamena, ze nase prediktory vysvetluju 33.61% variacie v Alcohol.
Hviezdičky pred hodnotami p-value znamenaju, ze su signifikantne.


```{r}

```{r}
# Quantile-quantile plot
qqnorm(model$residuals)
qqline(model$residuals)
```

```{r}
# Residuals vs Fitted plot
plot(model$residuals, model$fitted.values)
```

```{r}
# Normality test for hypothesis?
shapiro.test(model$residuals)

```
# TODO make smaller models



# Rozdelenie dát na trénovacie a testovacie

```{r}
# train test split
set.seed(123)
train_index <- sample(1:nrow(data), 0.8*nrow(data))
train_data <- data[train_index,]
test_data <- data[-train_index,]
train_data
test_data

```
TODO popisat v akom pomere a preco atd

# SVM model

```{r}
install.packages("e1071", repos="https://cloud.r-project.org/")
library(e1071)
model <- svm(`Life expectancy` ~ `Adult Mortality` + Alcohol  +
              `percentage expenditure` + BMI + 
              `Total expenditure` + Diphtheria + `HIV/AIDS` + GDP +
              `Income composition of resources` +
              Schooling, data = train_data)
summary(model)

predictions <- predict(model, test_data)
predictions

actual <- test_data$`Life expectancy`
actual

# confusion matrix
#confusion_matrix <- table(actual, predictions)
#confusion_matrix

# accuracy <- sum(diag(confusion_matrix)) / sum(confusion_matrix)
# accuracy

```
TODO popisat model a metriky

```{r}
install.packages("e1071", repos="https://cloud.r-project.org/")
library(e1071)

svm_model <- svm(`Life expectancy` ~ ., data = train_data, kernel = "radial")
svm_model

#svm_pred <- predict(svm_model, test_data)


```


```{r}

install.packages("countrycode")
library(countrycode)
data$Continent <- countrycode(data$Country, "country.name", "continent")
data

```